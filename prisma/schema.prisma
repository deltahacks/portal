generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "cockroachdb"
  url      = env("DATABASE_URL")
}

// Necessary for Next auth
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String?
  refresh_token_expires_in Int?
  access_token             String?
  expires_at               Int?
  ext_expires_in           Int?
  oauth_token_secret       String?
  oauth_token              String?
  token_type               String?
  scope                    String?
  id_token                 String?
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id                   String          @id @default(cuid())
  name                 String?
  email                String?         @unique
  emailVerified        DateTime?
  image                String?
  accounts             Account[]
  sessions             Session[]
  typeform_response_id String?
  role                 Role[]          @default([HACKER])
  hacker               Review[]        @relation("hacker")
  reviewer             Review[]        @relation("reviewer")
  judge                JudgingResult[] @relation("judge")
  status               Status          @default(IN_REVIEW)
  qrcode               Int?            @unique
  mealsTaken           Int             @default(0)
  lastMealTaken        DateTime?
  EventLog             EventLog[]

  dh10application   DH10Application? @relation(fields: [dH10ApplicationId], references: [id])
  dH10ApplicationId String?          @unique

  DH11Application   DH11Application? @relation(fields: [DH11ApplicationId], references: [id])
  DH11ApplicationId String?          @unique

  DH12Application   DH12Application? @relation(fields: [DH12ApplicationId], references: [id])
  DH12ApplicationId String?          @unique

  DH11Review DH11Review[]
  DH12Review DH12Review[]

  applicationResponses ApplicationResponse[]
}

model Review {
  id         String @id @default(cuid())
  hackerId   String
  reviewerId String
  mark       Float  @default(0)

  hacker   User @relation("hacker", fields: [hackerId], references: [id], onDelete: Cascade)
  reviewer User @relation("reviewer", fields: [reviewerId], references: [id], onDelete: Cascade)
}

model EventLog {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  timestamp DateTime @default(now())
  event     String
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum Role {
  HACKER
  ADMIN
  REVIEWER
  FOOD_MANAGER
  EVENT_MANAGER
  GENERAL_SCANNER
  SPONSER
  JUDGE
}

enum Status {
  IN_REVIEW
  REJECTED
  WAITLISTED
  ACCEPTED
  RSVP
  CHECKED_IN
}

model DH10Application {
  id String @id @default(cuid())

  firstName String
  lastName  String

  birthday DateTime

  studyEnrolledPostSecondary Boolean
  studyLocation              String?
  studyDegree                String?
  studyMajor                 String?
  studyYearOfStudy           String?
  studyExpectedGraduation    DateTime?

  previousHackathonsCount Int

  longAnswerChange     String
  longAnswerExperience String
  longAnswerTech       String
  longAnswerMagic      String

  socialText String?
  interests  String?

  linkToResume String?

  tshirtSize      String
  hackerKind      String
  alreadyHaveTeam Boolean
  workshopChoices String[]
  discoverdFrom   String[]
  considerCoffee  Boolean
  gender          String
  race            String
  macEv           Boolean  @default(false)

  emergencyContactName     String
  emergencyContactPhone    String
  emergencyContactRelation String

  agreeToMLHCodeOfConduct  Boolean
  agreeToMLHPrivacyPolicy  Boolean
  agreeToMLHCommunications Boolean

  User User?
}

model Config {
  id String @id @default(cuid())

  name  String @unique
  value String
}

model DH11Application {
  id String @id @default(cuid())

  firstName String
  lastName  String
  phone     String?
  country   String?
  birthday  DateTime

  // School
  studyEnrolledPostSecondary Boolean
  studyLocation              String?
  studyDegree                String?
  studyMajor                 String?
  studyYearOfStudy           String?
  studyExpectedGraduation    DateTime?

  previousHackathonsCount Int

  longAnswerIncident  String
  longAnswerGoals     String
  longAnswerFood      String
  longAnswerTravel    String
  longAnswerSocratica String

  socialText String[] @default([])
  interests  String?

  linkToResume String?

  tshirtSize          String
  hackerKind          String[] @default([])
  alreadyHaveTeam     Boolean
  workshopChoices     String[] @default([])
  discoverdFrom       String[] @default([])
  considerCoffee      Boolean
  dietaryRestrictions String?

  underrepresented YesNoUnsure?

  gender      String
  race        String
  orientation String

  emergencyContactName     String
  emergencyContactPhone    String
  emergencyContactRelation String

  agreeToMLHCodeOfConduct  Boolean
  agreeToMLHPrivacyPolicy  Boolean
  agreeToMLHCommunications Boolean

  rsvpCheck Boolean @default(false)

  User User?

  DH11Review DH11Review[]

  status Status @default(IN_REVIEW)
}

model DH12Application {
  id String @id @default(cuid())

  firstName String
  lastName  String
  phone     String?
  country   String?
  birthday  DateTime

  // School
  studyEnrolledPostSecondary Boolean
  studyLocation              String?
  studyDegree                String?
  studyMajor                 String?
  studyYearOfStudy           String?
  studyExpectedGraduation    DateTime?

  previousHackathonsCount Int

  longAnswerHobby     String
  longAnswerWhy       String
  longAnswerTime      String
  longAnswerSkill     String
  longAnswerSocratica String

  socialText String[] @default([])
  interests  String?

  linkToResume String?

  tshirtSize          String
  hackerKind          String[] @default([])
  alreadyHaveTeam     Boolean
  workshopChoices     String[] @default([])
  discoverdFrom       String[] @default([])
  considerCoffee      Boolean
  dietaryRestrictions String?

  underrepresented YesNoUnsure?
  gender           String?
  race             String?
  orientation      String?

  emergencyContactName     String
  emergencyContactPhone    String
  emergencyContactRelation String

  agreeToMLHCodeOfConduct  Boolean
  agreeToMLHPrivacyPolicy  Boolean
  agreeToMLHCommunications Boolean

  rsvpCheck Boolean @default(false)

  User User?

  DH12Review DH12Review[]

  status Status @default(IN_REVIEW)
}

model DH11Review {
  id String @id @default(cuid())

  score   Float
  comment String

  reviewerId    String
  applicationId String

  application DH11Application @relation(fields: [applicationId], references: [id], onDelete: NoAction)
  reviewer    User            @relation(fields: [reviewerId], references: [id])
}

model DH12Review {
  id String @id @default(cuid())

  score   Float
  comment String

  reviewerId    String
  applicationId String

  application DH12Application @relation(fields: [applicationId], references: [id], onDelete: NoAction)
  reviewer    User            @relation(fields: [reviewerId], references: [id])
}

enum YesNoUnsure {
  YES
  NO
  UNSURE
}

model ApplicationSchema {
  id          String           @id @default(cuid())
  name        String
  dhYear      String
  description String?
  isPublished Boolean          @default(false)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdBy   String?
  
  fields     ApplicationField[]
  responses  ApplicationResponse[]
  
  @@unique([name, dhYear])
}

model ApplicationField {
  id          String           @id @default(cuid())
  label       String
  type        FieldType
  required    Boolean          @default(false)
  placeholder String?
  helpText    String?
  options     String[]         @default([])
  validation  Json?
  order       Int              @default(0)
  
  schema      ApplicationSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  schemaId    String
  
  responses   ApplicationFieldResponse[]
  
  @@index([schemaId])
}

model ApplicationResponse {
  id          String           @id @default(cuid())
  status      Status           @default(IN_REVIEW)
  submittedAt DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  
  user        User             @relation(fields: [userId], references: [id])
  userId      String
  
  schema      ApplicationSchema @relation(fields: [schemaId], references: [id], onDelete: Cascade)
  schemaId    String
  
  answers     ApplicationFieldResponse[]
  grades      ApplicationGrade[]
  
  @@unique([userId, schemaId])
  @@index([schemaId])
}

model ApplicationFieldResponse {
  id          String           @id @default(cuid())
  value       String           @default("")
  
  response    ApplicationResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  responseId  String
  
  field       ApplicationField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId     String
  
  @@unique([responseId, fieldId])
  @@index([responseId])
}

enum FieldType {
  text
  textarea
  number
  select
  multiselect
  checkbox
  date
  email
  url
}

model RubricTemplate {
  id          String   @id @default(cuid())
  name        String
  description String?
  dhYear      String
  published   Boolean  @default(false)
  isActive    Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  criteria    RubricCriterion[]
}

model RubricCriterion {
  id          String   @id @default(cuid())
  templateId  String
  template    RubricTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  title       String
  description String
  maxPoints   Int      @default(10)
  
  order       Int      @default(0)
  category    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ApplicationGrade {
  id          String   @id @default(cuid())
  responseId  String
  response    ApplicationResponse @relation(fields: [responseId], references: [id], onDelete: Cascade)
  
  reviewerId  String
  score       Float
  feedback    String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  criteria    CriterionGrade[]
}

model CriterionGrade {
  id          String   @id @default(cuid())
  gradeId     String
  grade       ApplicationGrade @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  
  criterionId String
  score       Int
  comment     String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([gradeId, criterionId])
}

// Glossary:
// Track: Different topic/categories used to classify projects
model ProjectTrack {
  id        String  @id @default(cuid())
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  track     Track   @relation(fields: [trackId], references: [id], onDelete: Cascade)
  trackId   String

  @@unique([projectId, trackId])
}

model Track {
  id             String           @id @default(cuid())
  name           String           @unique
  ProjectTrack   ProjectTrack[]
  Table          Table[]
  RubricQuestion RubricQuestion[]
}

model Table {
  id            String          @id @default(cuid())
  number        Int             @unique
  trackId       String
  track         Track           @relation(fields: [trackId], references: [id])
  TimeSlot      TimeSlot[]
  JudgingResult JudgingResult[]
}

model Project {
  id             String          @id @default(cuid())
  name           String
  description    String
  link           String
  tracks         ProjectTrack[]
  judgingResults JudgingResult[]
  TimeSlot       TimeSlot[]
  dhYear         String
}

model TimeSlot {
  id        String   @id @default(cuid())
  startTime DateTime
  endTime   DateTime
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  table     Table    @relation(fields: [tableId], references: [id], onDelete: Cascade)
  tableId   String
  dhYear    String

  @@unique([projectId, startTime])
  @@unique([tableId, startTime])
}

model JudgingResult {
  id String @id @default(cuid())

  judgeId String
  judge   User   @relation("judge", fields: [judgeId], references: [id], onDelete: Cascade)

  project   Project          @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  responses RubricResponse[]
  dhYear    String

  table   Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)
  tableId String

  @@unique([judgeId, projectId])
}

model RubricQuestion {
  id        String           @id @default(cuid())
  title     String
  question  String
  points    Int
  trackId   String
  track     Track            @relation(fields: [trackId], references: [id], onDelete: Cascade)
  responses RubricResponse[]
}

model RubricResponse {
  id              String         @id @default(cuid())
  score           Int
  judgingResultId String
  questionId      String
  judgingResult   JudgingResult  @relation(fields: [judgingResultId], references: [id], onDelete: Cascade)
  question        RubricQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([judgingResultId, questionId])
}
